define(["app","echarts","directive/jrDatepicker","directive/jrDropdownButton"],function(app,echarts){$(window).on("keydown",function(e){27==e.keyCode&&$("#apigt").toggleClass("allview")}),app.registerController("RelationalAnomaly",["$scope","$http","$modal","$state","$stateParams","$filter","FileUploader",function($scope,$http,$modal,$state,$stateParams){function getCityData(params,callback){$http.get("/manage/highRisk-order/json/get/warnRelationGraph",{params:$.extend({},params,{optDesc:"风险订单图谱"})}).success(function(data2){$scope.allData=data2.object,setOption($scope.allData["graphLevel"+$scope.queryParams.graphLevel]),callback&&callback()})}function setOption(data2){curDate=data2;var data=$.extend({},data2);if($scope.queryParams.filtername){var arr=$scope.queryParams.filtername.split("、");data.pointList=getNodes(arr,curDate)}var sizeTypes=[40,45,50,55,60],colorTypes=["#b6a2de","#5ab1ef","#ffb980","#d87a80","#749f83","#bda29a","#2f4554"];option.color=["#ca8622"],option.legend.data=[],data.pointList.forEach(function(node){var rol=node.colorDetail;-1==option.legend.data.indexOf(rol)&&option.legend.data.push(rol);var col=colorTypes[node.colorType];-1==option.color.indexOf(col)&&option.color.push(col)}),option.series[0].categories=option.legend.data.map(function(name){return{name:name}}),option.series[0].data=data.pointList.map(function(node){return node.category=option.legend.data.indexOf(node.colorDetail),node.symbolSize=sizeTypes[node.sizeType],node.itemStyle={normal:{borderType:"solid",borderColor:colorTypes[node.colorType],color:"#fff",borderWidth:5},emphasis:{borderWidth:5}},node}),option.series[0].links=data.edgeList.map(function(node){return node.source=""+node.source,node.target=""+node.target,node.label={normal:{formatter:function(pattams){return pattams.data.detail}}},node.lineStyle={normal:{color:"#666"}},node}),myCityChart.setOption(option,!0)}function getNodes(nameArr,curDate){var idArr=[];if(curDate.pointList.forEach(function(item){var p=nameArr.indexOf(item.name);p>-1&&(idArr[p]=item.id)}),0==idArr.length)return[];var list=[];curDate.edgeList.forEach(function(item){idArr.indexOf(item.source)>-1&&-1==list.indexOf(item.target)&&list.push(item.target),idArr.indexOf(item.target)>-1&&-1==list.indexOf(item.source)&&list.push(item.source)}),list=list.concat(idArr);var itemArr=[];return curDate.pointList.forEach(function(item){list.indexOf(item.id)>-1&&itemArr.push(item)}),itemArr}$scope.queryParams=$.extend({pageNum:1,graphLevel:"1",filtername:""},$stateParams),$scope.queryOptions={graphLevel:[{value:"1",name:"1重关系"},{value:"2",name:"2重关系"},{value:"3",name:"3重关系"}]};var curDate;$scope.quanpin=function(){$(".table-con").toggleClass("allview")},$scope.$watch("queryParams.graphLevel",function(newValue,oldValue){return newValue===oldValue?!1:void($scope.allData&&setOption($scope.allData["graphLevel"+newValue]))}),$scope.search=function(){$scope.queryParams.pageNum=1,$state.go("apigraph.list",$scope.queryParams,{reload:!0})};var option={legend:{data:[],x:"left"},tooltip:{formatter:function(params){return"node"==params.dataType?params.data.detail:"edge"==params.dataType?params.data.detail:void 0}},series:[{edgeSymbol:["","arrow"],edgeSymbolSize:8,type:"graph",layout:"force",animation:!1,label:{normal:{show:!0,position:"inside",formatter:"{b}",textStyle:{color:"#333"}}},draggable:!0,roam:!0,data:[],categories:[],force:{layoutAnimation:!1,gravity:.2,edgeLength:200,repulsion:2e3},lineStyle:{normal:{color:"source"}},edgeLabel:{normal:{show:!0}},links:[]}]},myCityChart=echarts.init(document.getElementById("successView"));getCityData($scope.queryParams),myCityChart.on("dblclick",function(param){var data=param.data;if(data.orderid){var href=$state.href("order.check",{orderId:data.orderid,flag:1});window.open(href)}}),$(".form-body").css({width:"100%"});var ctrlDown=!1;$(window).keydown(function(e){17==e.keyCode&&(ctrlDown=!0)}),$(window).keyup(function(e){17==e.keyCode&&(ctrlDown=!1)}),myCityChart.on("click",function(param){if("node"==param.dataType){var data=param.data;-1==$scope.queryParams.filtername.indexOf(data.name)&&($scope.queryParams.filtername=($scope.queryParams.filtername+"、"+data.name).replace("、、","、").replace(/^、/,"")),ctrlDown&&($scope.queryParams.filtername=data.name,setOption(curDate)),$("#filtername").val($scope.queryParams.filtername)}})}])});